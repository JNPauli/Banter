

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>General linear model &#8212; Mental image decoding - A student research project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'data/General_linear_model';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Machine Learning" href="../general_information/Machine_Learning.html" />
    <link rel="prev" title="Dataset Exploration" href="Dataset_Exploration.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_mental_imagery.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo_mental_imagery.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../general_information/Research_question.html">Research Question aka what is this project all about?</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../general_information/Data_and_Projectmanagment.html">Data- and Projectmanagment</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../open_lab_notebook/Documentation.html">Documentation</a></li>






</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Dataset_Exploration.html">Dataset Exploration</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">General linear model</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../general_information/Machine_Learning.html">Machine Learning</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../code/Logistic_Regression.html">Logistic Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../code/Support_Vector_Machine.html">Support Vector Machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../code/Neural_network.html">Deep Neural Network</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Discussion/Results.html">Discussion</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/JNPauli/Mental-image-decoding/Main?urlpath=tree/content/data/General_linear_model.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/JNPauli/Mental-image-decoding" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/JNPauli/Mental-image-decoding/edit/Main/content/data/General_linear_model.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/JNPauli/Mental-image-decoding/issues/new?title=Issue%20on%20page%20%2Fdata/General_linear_model.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/data/General_linear_model.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>General linear model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><strong>0. Introduction</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-model"><strong>1.0 Running the model</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detection-of-significant-voxels"><strong>2.0 Detection of significant voxels</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-glm-for-all-runs"><strong>3.0 Performing the glm for all runs</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-check"><strong>4.0 Quality check</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-evaluation"><strong>4.1 Model evaluation</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-the-results-with-literature"><strong>4.2 Comparing the results with literature</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-design-matrices"><strong>4.3 Plotting design matrices</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-z-maps-perrun-for-all-sessions"><strong>5.0 Calculating z-maps perrun for all  sessions</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression"><strong>6.0 Logistic Regression</strong></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="general-linear-model">
<h1>General linear model<a class="headerlink" href="#general-linear-model" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2><strong>0. Introduction</strong><a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>This notebook holds the code for the <code class="docutils literal notranslate"><span class="pre">general</span> <span class="pre">linear</span> <span class="pre">model</span></code>.</p>
<p>First we will need to load the data. We are now dealing with the preprocessed data. The preprocessing has been done with using <a class="reference external" href="https://fmriprep.org/en/stable/">fMRI-prep</a>. fMRIprep describes itself as such “(…)It performs basic processing steps (coregistration, normalization, unwarping, noise component extraction, segmentation, skullstripping etc.) providing outputs that can be easily submitted to a variety of group level analyses, including task-based or resting-state fMRI, graph theory measures, surface or volume-based statistics, etc.”</p>
<p>Thus, we will now perform our first level model. The predictors are the respective categories of the stimuli. The dependent variable is the brain activity in a given voxel.
So lets start by loading the data! For now we are dealing with the first five runs of subject one, for the first session in the imagery task.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/sub01-ses-01-imagery&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now take a look at all the files we have. In total, we have five runs. For each run, we have .json file, a nii.gz file and a confounds.tsv file. In the Dataset_Exploration notebook we had a similar structure. But instead of the events.tsv file, we now have the confounds file. The confound file contain the regressors of no interest. Those are variables, that we should explicitly exclude from our first level model and are computed during the preprocessing. We also see that we have preprocessed data, because the respective file names carry the additional “preproc”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.json</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_confounds.tsv</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.json</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.nii.gz</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_confounds.tsv</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.json</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.nii.gz</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_confounds.tsv</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.json</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.nii.gz</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_confounds.tsv</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.json</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.nii.gz</span>*
<span class=" -Color -Color-Bold -Color-Bold-Green">sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_confounds.tsv</span>*
<span class=" -Color -Color-Blue -Color-Blue-BGGreen">z_maps</span>/
</pre></div>
</div>
</div>
</div>
<p>We can now load one sample confounds.tsv file, to see what regressors of no interest are</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">confounds</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_confounds.tsv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">confounds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>global_signal</th>
      <th>global_signal_derivative1</th>
      <th>global_signal_derivative1_power2</th>
      <th>global_signal_power2</th>
      <th>csf</th>
      <th>csf_derivative1</th>
      <th>csf_power2</th>
      <th>csf_derivative1_power2</th>
      <th>white_matter</th>
      <th>white_matter_derivative1</th>
      <th>...</th>
      <th>rot_z_derivative1</th>
      <th>rot_z_power2</th>
      <th>rot_z_derivative1_power2</th>
      <th>motion_outlier00</th>
      <th>motion_outlier01</th>
      <th>motion_outlier02</th>
      <th>motion_outlier03</th>
      <th>motion_outlier04</th>
      <th>motion_outlier05</th>
      <th>motion_outlier06</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>554.498550</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>307468.641921</td>
      <td>826.870090</td>
      <td>NaN</td>
      <td>683714.146374</td>
      <td>NaN</td>
      <td>551.701398</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.000031</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>552.545617</td>
      <td>-1.952933</td>
      <td>3.813947</td>
      <td>305306.659011</td>
      <td>815.862929</td>
      <td>-11.007161</td>
      <td>665632.319586</td>
      <td>121.157593</td>
      <td>551.526335</td>
      <td>-0.175063</td>
      <td>...</td>
      <td>-0.000709</td>
      <td>0.000040</td>
      <td>5.032484e-07</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>550.823228</td>
      <td>-1.722389</td>
      <td>2.966623</td>
      <td>303406.228820</td>
      <td>810.248197</td>
      <td>-5.614732</td>
      <td>656502.140689</td>
      <td>31.525220</td>
      <td>551.675734</td>
      <td>0.149399</td>
      <td>...</td>
      <td>-0.000045</td>
      <td>0.000040</td>
      <td>2.061160e-09</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>548.659178</td>
      <td>-2.164050</td>
      <td>4.683113</td>
      <td>301026.893801</td>
      <td>807.405975</td>
      <td>-2.842222</td>
      <td>651904.408184</td>
      <td>8.078227</td>
      <td>551.932003</td>
      <td>0.256269</td>
      <td>...</td>
      <td>0.000220</td>
      <td>0.000038</td>
      <td>4.852768e-08</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>547.315987</td>
      <td>-1.343191</td>
      <td>1.804162</td>
      <td>299554.789688</td>
      <td>806.497248</td>
      <td>-0.908726</td>
      <td>650437.811788</td>
      <td>0.825784</td>
      <td>550.669163</td>
      <td>-1.262840</td>
      <td>...</td>
      <td>0.000058</td>
      <td>0.000037</td>
      <td>3.414065e-09</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>222</th>
      <td>554.966041</td>
      <td>-1.277939</td>
      <td>1.633127</td>
      <td>307987.307133</td>
      <td>813.088753</td>
      <td>-6.370867</td>
      <td>661113.320100</td>
      <td>40.587943</td>
      <td>552.662723</td>
      <td>-0.652898</td>
      <td>...</td>
      <td>0.000004</td>
      <td>0.000019</td>
      <td>1.436410e-11</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>223</th>
      <td>554.111798</td>
      <td>-0.854243</td>
      <td>0.729731</td>
      <td>307039.885019</td>
      <td>810.995302</td>
      <td>-2.093451</td>
      <td>657713.379057</td>
      <td>4.382539</td>
      <td>552.448883</td>
      <td>-0.213841</td>
      <td>...</td>
      <td>0.000335</td>
      <td>0.000016</td>
      <td>1.119772e-07</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>224</th>
      <td>553.453749</td>
      <td>-0.658049</td>
      <td>0.433028</td>
      <td>306311.052626</td>
      <td>815.053154</td>
      <td>4.057853</td>
      <td>664311.643996</td>
      <td>16.466168</td>
      <td>552.643977</td>
      <td>0.195094</td>
      <td>...</td>
      <td>-0.000573</td>
      <td>0.000021</td>
      <td>3.285238e-07</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>225</th>
      <td>551.820319</td>
      <td>-1.633431</td>
      <td>2.668096</td>
      <td>304505.664025</td>
      <td>808.053376</td>
      <td>-6.999778</td>
      <td>652950.258208</td>
      <td>48.996896</td>
      <td>552.455372</td>
      <td>-0.188605</td>
      <td>...</td>
      <td>-0.000682</td>
      <td>0.000028</td>
      <td>4.651786e-07</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>226</th>
      <td>553.363106</td>
      <td>1.542787</td>
      <td>2.380193</td>
      <td>306210.727138</td>
      <td>809.010798</td>
      <td>0.957423</td>
      <td>654498.471869</td>
      <td>0.916658</td>
      <td>552.985391</td>
      <td>0.530019</td>
      <td>...</td>
      <td>-0.000365</td>
      <td>0.000032</td>
      <td>1.334295e-07</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>227 rows × 243 columns</p>
</div></div></div>
</div>
<div class="alert alert-block alert-success">
While there are certainly a lot of confound variable (243, to be exact) we are not including all of them in our first level analysis. For the course purpose, we will only include the rotational parameters pitch, yaw, roll [rot x, rot y and rot z], the translational axes x, y and z [trans x, trans y, trans z] and the global signal.</div><p>We can extract the respective columns from our <em>confounds</em> dataframe and create a new one, that only containts the regressors of no interest</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_no_interest</span> <span class="o">=</span> <span class="n">confounds</span><span class="p">[[</span><span class="s1">&#39;global_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_x&#39;</span><span class="p">,</span><span class="s1">&#39;trans_z&#39;</span><span class="p">,</span><span class="s1">&#39;trans_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_x&#39;</span><span class="p">,</span><span class="s1">&#39;rot_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_no_interest</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>global_signal</th>
      <th>trans_x</th>
      <th>trans_z</th>
      <th>trans_y</th>
      <th>rot_x</th>
      <th>rot_y</th>
      <th>rot_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>554.498550</td>
      <td>0.152997</td>
      <td>0.059195</td>
      <td>0.124130</td>
      <td>-0.004563</td>
      <td>0.007716</td>
      <td>-0.005596</td>
    </tr>
    <tr>
      <th>1</th>
      <td>552.545617</td>
      <td>0.174779</td>
      <td>0.158409</td>
      <td>0.017678</td>
      <td>-0.003366</td>
      <td>0.007310</td>
      <td>-0.006305</td>
    </tr>
    <tr>
      <th>2</th>
      <td>550.823228</td>
      <td>0.171488</td>
      <td>0.189918</td>
      <td>0.002432</td>
      <td>-0.002752</td>
      <td>0.007173</td>
      <td>-0.006351</td>
    </tr>
    <tr>
      <th>3</th>
      <td>548.659178</td>
      <td>0.168912</td>
      <td>0.155673</td>
      <td>0.054476</td>
      <td>-0.003509</td>
      <td>0.007052</td>
      <td>-0.006131</td>
    </tr>
    <tr>
      <th>4</th>
      <td>547.315987</td>
      <td>0.171913</td>
      <td>0.199063</td>
      <td>0.030412</td>
      <td>-0.003196</td>
      <td>0.007388</td>
      <td>-0.006072</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>222</th>
      <td>554.966041</td>
      <td>-0.271419</td>
      <td>0.030273</td>
      <td>-0.364504</td>
      <td>0.006790</td>
      <td>-0.017684</td>
      <td>-0.004396</td>
    </tr>
    <tr>
      <th>223</th>
      <td>554.111798</td>
      <td>-0.240987</td>
      <td>-0.066789</td>
      <td>-0.252943</td>
      <td>0.005830</td>
      <td>-0.016664</td>
      <td>-0.004061</td>
    </tr>
    <tr>
      <th>224</th>
      <td>553.453749</td>
      <td>-0.195186</td>
      <td>-0.108477</td>
      <td>-0.237718</td>
      <td>0.005214</td>
      <td>-0.015303</td>
      <td>-0.004634</td>
    </tr>
    <tr>
      <th>225</th>
      <td>551.820319</td>
      <td>-0.225104</td>
      <td>-0.083225</td>
      <td>-0.247957</td>
      <td>0.004335</td>
      <td>-0.015039</td>
      <td>-0.005316</td>
    </tr>
    <tr>
      <th>226</th>
      <td>553.363106</td>
      <td>-0.237460</td>
      <td>-0.057182</td>
      <td>-0.257723</td>
      <td>0.004266</td>
      <td>-0.015373</td>
      <td>-0.005682</td>
    </tr>
  </tbody>
</table>
<p>227 rows × 7 columns</p>
</div></div></div>
</div>
<p>This looks good! Now that we took care of the confounds, its time to import nilearns FirstLevelModel function.
This function creates a <code class="docutils literal notranslate"><span class="pre">design</span> <span class="pre">matrix</span></code> and uses the information provided by the events file.</p>
<p>The function requires a lot of different parameters to be set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">FirstLevelModel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/nilearn/glm/__init__.py:56: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  &#39;It may change in any future release of Nilearn.&#39;, FutureWarning)
</pre></div>
</div>
</div>
</div>
<p>For the sake of the course purpose, we will stick to the default settings. Only t_r (= the time of repetition of acquisitions) and the hrf_model (hemodynamic response model) need to be adapted.</p>
<div class="alert alert-block alert-success">
We get the time of repetition from the respective json file!.</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">meta_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
<span class="n">meta_file</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;DelayTime&#39;: 0.09749999999999992,
 &#39;RepetitionTime&#39;: 2.0,
 &#39;SkullStripped&#39;: False,
 &#39;SliceTimingCorrected&#39;: True,
 &#39;StartTime&#39;: 0.951,
 &#39;TaskName&#39;: &#39;imagery&#39;}
</pre></div>
</div>
</div>
</div>
<p>The t_r is 2.0 seconds. Now that we have this parameter we are almost good to go. For the first level model the hrf model is set to SPM, so we also have this information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmri_glm</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">hrf_model</span> <span class="o">=</span> <span class="s1">&#39;spm&#39;</span><span class="p">,</span>
                           <span class="n">slice_time_ref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> 
                           <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span>
                           <span class="n">high_pass</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> 
                           <span class="n">noise_model</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span>
                           <span class="n">minimize_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As mentioned before, we need the events.tsv file for the FirstLevelModel and thus the design matrix. Lets load this file so we can continue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;/home/jpauli/ds001506/sub-01/ses-imagery01/func/sub-01_ses-imagery01_task-imagery_run-01_events.tsv&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">events</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>onset</th>
      <th>duration</th>
      <th>trial_no</th>
      <th>event_type</th>
      <th>category_id</th>
      <th>category_name</th>
      <th>category_index</th>
      <th>response_time</th>
      <th>evaluation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>32.0</td>
      <td>1.0</td>
      <td>-1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>32.0</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>1</td>
      <td>1976957.0</td>
      <td>n01976957</td>
      <td>7.0</td>
      <td>44.967050</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36.0</td>
      <td>8.0</td>
      <td>2.0</td>
      <td>2</td>
      <td>1976957.0</td>
      <td>n01976957</td>
      <td>7.0</td>
      <td>44.967050</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>44.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>3</td>
      <td>1976957.0</td>
      <td>n01976957</td>
      <td>7.0</td>
      <td>44.967050</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>47.0</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>4</td>
      <td>1976957.0</td>
      <td>n01976957</td>
      <td>7.0</td>
      <td>44.967050</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>101</th>
      <td>432.0</td>
      <td>4.0</td>
      <td>27.0</td>
      <td>1</td>
      <td>1943899.0</td>
      <td>n01943899</td>
      <td>6.0</td>
      <td>445.498226</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>102</th>
      <td>436.0</td>
      <td>8.0</td>
      <td>27.0</td>
      <td>2</td>
      <td>1943899.0</td>
      <td>n01943899</td>
      <td>6.0</td>
      <td>445.498226</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>103</th>
      <td>444.0</td>
      <td>3.0</td>
      <td>27.0</td>
      <td>3</td>
      <td>1943899.0</td>
      <td>n01943899</td>
      <td>6.0</td>
      <td>445.498226</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>104</th>
      <td>447.0</td>
      <td>1.0</td>
      <td>27.0</td>
      <td>4</td>
      <td>1943899.0</td>
      <td>n01943899</td>
      <td>6.0</td>
      <td>445.498226</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>105</th>
      <td>448.0</td>
      <td>6.0</td>
      <td>28.0</td>
      <td>-2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>106 rows × 9 columns</p>
</div></div></div>
</div>
<p>From this file, we need the to save the <strong>onset</strong>, <strong>duration</strong> and the <strong>trial_type</strong>. However, we do not have the trial_type column yet. This column should tell us which respective trial we are dealing with at a given timestap. This is already given in the event_type column, but we need to translate the integers to an actual informative string. Also, we cannot simply assign every imagery trial the same value. We want to differantiate between the different stimuli.
So before extracting the onset and duration column, we will first create the trial_type column and then proceed. This column indicates, when rest, cue presentation, imagery evaluation or inter-trial and post rest periods happened. Also it informs us, which exact stimuli was imagined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trial_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ABC&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">])</span>
<span class="n">category</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rest&#39;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Cue presentation&#39;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagery&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Imagery evaluation&#39;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inter-trial and post rest period&#39;</span>
        
        
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">event_sub_ses_run_01</span> <span class="o">=</span> <span class="n">events</span><span class="p">[[</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">]]</span>
<span class="n">event_sub_ses_run_01</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trial_type</span>
<span class="n">event_sub_ses_run_01</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>onset</th>
      <th>duration</th>
      <th>trial_type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>32.0</td>
      <td>Rest</td>
    </tr>
    <tr>
      <th>1</th>
      <td>32.0</td>
      <td>4.0</td>
      <td>Cue presentation</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36.0</td>
      <td>8.0</td>
      <td>imagery1976957.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>44.0</td>
      <td>3.0</td>
      <td>Imagery evaluation</td>
    </tr>
    <tr>
      <th>4</th>
      <td>47.0</td>
      <td>1.0</td>
      <td>inter-trial and post rest period</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>101</th>
      <td>432.0</td>
      <td>4.0</td>
      <td>Cue presentation</td>
    </tr>
    <tr>
      <th>102</th>
      <td>436.0</td>
      <td>8.0</td>
      <td>imagery1943899.0</td>
    </tr>
    <tr>
      <th>103</th>
      <td>444.0</td>
      <td>3.0</td>
      <td>Imagery evaluation</td>
    </tr>
    <tr>
      <th>104</th>
      <td>447.0</td>
      <td>1.0</td>
      <td>inter-trial and post rest period</td>
    </tr>
    <tr>
      <th>105</th>
      <td>448.0</td>
      <td>6.0</td>
      <td>inter-trial and post rest period</td>
    </tr>
  </tbody>
</table>
<p>106 rows × 3 columns</p>
</div></div></div>
</div>
<p>The last thing we need is the fMRI img. We get this by loading the functional image and then applying nilearns mean_img function to it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_func_img</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/sessions_new/sub01-ses-01-imagery&#39;</span> 
<span class="n">fmri_img</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_func_img</span> <span class="p">,</span><span class="s1">&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">mean_img</span> 
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_stat_map</span><span class="p">,</span> <span class="n">plot_anat</span><span class="p">,</span> <span class="n">plot_img</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">plot_glass_brain</span>
<span class="n">mean_img_</span> <span class="o">=</span> <span class="n">mean_img</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">)</span>
<span class="n">plot_img</span><span class="p">(</span><span class="n">mean_img_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f02b0e9b908&gt;
</pre></div>
</div>
<img alt="../_images/6685ea4bc9565de9c87a387677b7a5caae6bf32ee59ae258681f29eef570e198.png" src="../_images/6685ea4bc9565de9c87a387677b7a5caae6bf32ee59ae258681f29eef570e198.png" />
</div>
</div>
</section>
<section id="running-the-model">
<h2><strong>1.0 Running the model</strong><a class="headerlink" href="#running-the-model" title="Permalink to this heading">#</a></h2>
<p>Now it is time to run our defined first level model. We are using our mean fMRI img and our event and confound file. This results in a <em>design matrix</em>. The design matrix is informing us about a given activity for the respective regressor and for a given scan number. We have a recording frequency of 2 seconds. The whole paradigm took about 400 seconds (see: Dataset_Exploration.ipynb). This is why the only have 200 scan numbers on our y-axis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmri_glm</span> <span class="o">=</span> <span class="n">fmri_glm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img</span><span class="p">,</span> <span class="n">event_sub_ses_run_01</span><span class="p">,</span> <span class="n">reg_no_interest</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">fmri_glm</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_design_matrix</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:label=&#39;conditions&#39;, ylabel=&#39;scan number&#39;&gt;
</pre></div>
</div>
<img alt="../_images/5aa4f378352f26d46a0202a0de401ccc409089c812cf52ad09ade1bce8d60530.png" src="../_images/5aa4f378352f26d46a0202a0de401ccc409089c812cf52ad09ade1bce8d60530.png" />
</div>
</div>
<p>We can also plot the expected response for a given category. This tells us at which time there was a BOLD response for the respective category.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">[</span><span class="s1">&#39;imagery14435370&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Expected Response for category 14435370&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Expected Response for category 14435370&#39;)
</pre></div>
</div>
<img alt="../_images/242404b926dd9c01cbd3e4fcfa336ccfd76d31a35447f38f16ed0320d51206e7.png" src="../_images/242404b926dd9c01cbd3e4fcfa336ccfd76d31a35447f38f16ed0320d51206e7.png" />
</div>
</div>
</section>
<section id="detection-of-significant-voxels">
<h2><strong>2.0 Detection of significant voxels</strong><a class="headerlink" href="#detection-of-significant-voxels" title="Permalink to this heading">#</a></h2>
<p>In order to estimate our Betas of the GLM, we need to calculate the contrasts for all conditions. By doing this, we are weighting the columns to discover the associated statistics.</p>
<p>This requires some data wrangling. First, we need to extract all unique values from our <em>event</em> file, so we only have the stimuli presented in the paradigm. Before, we have to sort the values, because our design matrix follows a ascending order. Then we remove the one NaN from this list. After that, we will create the variable <strong>conditions</strong>. This list containts the prefix “active”, so we know we are dealing with an activated brain region and is added by the respective condition name.</p>
<p>Then an array of the length of all regressors is created. For each of our regressors of interest, so for all our conditions, i.e. imagery stimuli, a weight is assigned. One thing is very important here: Our design matrix tells us, that the first three regressors are <strong>NOT</strong> the imagery conditions but rather the cue presentation, rest and imagery evaluation. Due to this, we have to start by assigning the first weight to the <code class="docutils literal notranslate"><span class="pre">fourth</span></code> zero of our array. This is then combined into a dictionary, so it can serve as in input to the nilearn function <strong>plot_contrast_matrix</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="n">events</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="n">con</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">category_id</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">con_no_NaN</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">con</span> <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spaceholder&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">con_no_NaN</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">con_no_NaN</span><span class="p">):</span>
    <span class="n">conditions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;active -&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>
<span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">array_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">k</span><span class="o">=</span><span class="mi">1</span>
<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span>
    <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">array_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">continue</span>
   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;active -1443537.0&#39;: array([0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1621127.0&#39;: array([0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1677366.0&#39;: array([0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1846331.0&#39;: array([0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1858441.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1943899.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -1976957.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2071294.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2128385.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2139199.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2190790.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2274259.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2416519.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2437136.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2437971.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2690373.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2797295.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2824058.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2882301.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2916179.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2950256.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -2951358.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -3064758.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -3122295.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -3124170.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0]),
 &#39;active -3237416.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0])}
</pre></div>
</div>
</div>
</div>
<p>After finishing the data wrangling, it is finally time to compute the contrasts and plot the coefficients.</p>
<div class="alert alert-block alert-success">
For now, we will plot and compute the contrast matrix for the condition 'active - 16773660'. </div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_contrast_matrix</span>
<span class="n">plot_contrast_matrix</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s1">&#39;active -1677366.0&#39;</span><span class="p">],</span> <span class="n">design_matrix</span><span class="o">=</span><span class="n">design_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:label=&#39;conditions&#39;&gt;
</pre></div>
</div>
<img alt="../_images/02fec068624d4c2df0bdd5eef22ad9c4cd9b47b9fae159e640960b759b66191b.png" src="../_images/02fec068624d4c2df0bdd5eef22ad9c4cd9b47b9fae159e640960b759b66191b.png" />
</div>
</div>
<p>We can also compute the effect size for the contrast. This must be done, because the BOLD signal unit inherits no statistical guarantee, mainly because the associated variance is not taken into account. We can compute a t test and z-transform the values, meaning the mean is equal to 0 and the variance is equal to 1 across voxels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eff_map</span> <span class="o">=</span> <span class="n">fmri_glm</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s1">&#39;active -1677366.0&#39;</span><span class="p">],</span>
                                    <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;effect_size&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_map</span> <span class="o">=</span> <span class="n">fmri_glm</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span><span class="n">condition</span><span class="p">[</span><span class="s1">&#39;active -1677366.0&#39;</span><span class="p">],</span>
                                  <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;z_score&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
The z map serves combined with the condition labels as the input for nilearns decoding pipeline.
</div><p>Its time to plot the z_map on top of the fMRI img. There are several approaches to define statistical tresholds. We will control for the false discovery rate, meaning the amount of false discoveries relative to all detections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.glm.thresholding</span> <span class="kn">import</span> <span class="n">threshold_stats_img</span>
<span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;False Discovery rate = 0.05 threshold: </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">threshold</span><span class="p">)</span>
<span class="n">plot_stat_map</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
              <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="s1">&#39;active -1677366.0 (fdr=0.05)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False Discovery rate = 0.05 threshold: 2.599
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f02ac138ac8&gt;
</pre></div>
</div>
<img alt="../_images/806cf472b4a8ffc386db229cc30769dfbd7720d66f0995acaa614cabfb5ebee5.png" src="../_images/806cf472b4a8ffc386db229cc30769dfbd7720d66f0995acaa614cabfb5ebee5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_glass_brain</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_abs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;active -1677366.0(fdr=0.05)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._projectors.OrthoProjector at 0x7f02a57be908&gt;
</pre></div>
</div>
<img alt="../_images/f242e95dadae9b2a0e401d1efcc36f5216eb5306fb6a0595862d1556d77dfa55.png" src="../_images/f242e95dadae9b2a0e401d1efcc36f5216eb5306fb6a0595862d1556d77dfa55.png" />
</div>
</div>
</section>
<section id="performing-the-glm-for-all-runs">
<h2><strong>3.0 Performing the glm for all runs</strong><a class="headerlink" href="#performing-the-glm-for-all-runs" title="Permalink to this heading">#</a></h2>
<p>Now that we demonstrated the process for one single run, we want to execute the GLM for all runs we have.
First, we can start by saving all functional images in one list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmri_img_all_runs</span> <span class="o">=</span> <span class="p">[]</span>

    
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
     <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span>
     <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">):</span> 
         <span class="n">fmri_img_all_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
         <span class="k">continue</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmri_img_all_runs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;]
</pre></div>
</div>
</div>
</div>
<p>Compute the mean_img for every image we just saved in the <em>fmri_img_all_runs</em> variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_img_all</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fmri_img_all_runs</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mean_img</span><span class="p">(</span><span class="n">fmri_img_all_runs</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">mean_img_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Save all confounds</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confounds_all_runs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">):</span>
        <span class="n">confounds_all_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.json&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_confounds.tsv&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.json&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_confounds.tsv&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.json&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_confounds.tsv&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.json&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_confounds.tsv&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.json&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_confounds.tsv&#39;,
 &#39;z_maps&#39;]
</pre></div>
</div>
</div>
</div>
<p>And then extract all regressors of no interest!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg_no_interest_all</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">confounds_all_runs</span><span class="p">:</span>
    
    <span class="n">reg_no_interest_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="s1">&#39;global_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_x&#39;</span><span class="p">,</span><span class="s1">&#39;trans_z&#39;</span><span class="p">,</span><span class="s1">&#39;trans_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_x&#39;</span><span class="p">,</span><span class="s1">&#39;rot_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Load all event files</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/home/jpauli/ds001506/sub-01/ses-imagery01/func&#39;</span><span class="p">)</span>
<span class="n">events_all_runs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span>
    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">):</span>
        <span class="n">events_all_runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>
    
</pre></div>
</div>
</div>
</div>
<p>Now once again we have to get the trialtype aka the stimuli seperated from the event files. For this case I created the <em>trialtype</em> function. After that, we extract onset and duration and create a new list called regressors_of_interest. This list contains the onset and duration of our regressors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trialtype</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">trial_type</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPACE&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">])</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Rest&#39;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Cue presentation&#39;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;imagery&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">category</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Imagery evaluation&#39;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">trial_type</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;inter-trial and post rest period&#39;</span>
    <span class="k">return</span> <span class="n">trial_type</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stimuli_all</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">files</span><span class="p">,</span> <span class="n">events</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events_all_runs</span><span class="p">):</span>
    <span class="n">stimuli_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trialtype</span><span class="p">(</span><span class="n">events_all_runs</span><span class="p">[</span><span class="n">files</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regressors_of_interest</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">files</span><span class="p">,</span><span class="n">events</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">events_all_runs</span><span class="p">):</span>
    <span class="n">regressors_of_interest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">events_all_runs</span><span class="p">[</span><span class="n">files</span><span class="p">][[</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">]])</span>
    <span class="n">regressors_of_interest</span><span class="p">[</span><span class="n">files</span><span class="p">][</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stimuli_all</span><span class="p">[</span><span class="n">files</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:5: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  &quot;&quot;&quot;
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
To proceed, it is necessary to define the design matrices for the respective runs. This is done by using the make_first_level_design_matrix function from nilearn.glm.first_level module.</div><p>First, we need to define some parameters. The times of repetition (T_R) as taken from the bold.json file.
The frame times. This is equal to the number of scans multiplied by the times of repetition.
The number of scans is simply the duration of the whole run divided by the T_R.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">arange</span>
<span class="n">T_R</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">n_scans</span> <span class="o">=</span> <span class="mi">227</span> 
<span class="n">frame_times</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">n_scans</span><span class="p">)</span><span class="o">*</span><span class="n">T_R</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">make_first_level_design_matrix</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we just loop through our predefined variables and create a design matrix for each run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">make_first_level_design_matrix</span>
<span class="n">hrf_model</span> <span class="o">=</span> <span class="s1">&#39;glover&#39;</span>
<span class="n">runs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_first_level_design_matrix</span><span class="p">(</span>
    <span class="n">frame_times</span><span class="p">,</span> <span class="n">regressors_of_interest</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;polynomial&#39;</span><span class="p">,</span> <span class="n">drift_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">add_regs</span><span class="o">=</span><span class="n">reg_no_interest_all</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">add_reg_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="n">hrf_model</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Next step is to simply create and then fit our first level model on the respective fmri images and matrices we just calculated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">glm</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span> <span class="o">=</span> <span class="n">T_R</span><span class="p">,</span> <span class="n">hrf_model</span> <span class="o">=</span> <span class="s1">&#39;spm&#39;</span><span class="p">,</span>
                           <span class="n">slice_time_ref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> 
                           <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span>
                           <span class="n">high_pass</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> 
                           <span class="n">noise_model</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span>
                           <span class="n">minimize_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/sub01-ses-01-imagery&#39;</span><span class="p">)</span>
<span class="n">glm</span> <span class="o">=</span> <span class="n">glm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fmri_img_all_runs</span><span class="p">,</span> <span class="n">design_matrices</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we need to compute the contrasts. Since the stimuli are all the same for every run, we can just use the category list from above</p>
<div class="alert alert-block alert-danger">
CAVE:
<p>In the first example of running the glm for only one run, I first created a design matrix that contained 47 regressors. This is because there are the variables drift 1 to drift 9. However, when calculating the design matrices for each run, I only get the variables drift 1 to drift 3. Thats why I needed to adapt the contrast dictionary from run one. </div></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span>
<span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">array_a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">k</span><span class="o">=</span><span class="mi">1</span>
<span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span>
    <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_a</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">array_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_a</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">condition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;active -1443537.0&#39;: array([0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1621127.0&#39;: array([0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1677366.0&#39;: array([0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1846331.0&#39;: array([0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1858441.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1943899.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -1976957.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2071294.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2128385.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2139199.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2190790.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2274259.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2416519.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2437136.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2437971.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2690373.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2797295.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2824058.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2882301.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2916179.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2950256.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -2951358.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -3064758.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -3122295.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -3124170.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]),
 &#39;active -3237416.0&#39;: array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/sub01-ses-01-imagery/z_maps&#39;</span><span class="p">)</span>
<span class="n">write_dir</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/sub01-ses-01-imagery/z_maps&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computing contrasts...&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Contrast </span><span class="si">% 2i</span><span class="s1"> out of </span><span class="si">%i</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">condition</span><span class="p">),</span> <span class="n">contrast_id</span><span class="p">))</span>
    <span class="c1">#Estimate the contasts. Note that the model implicitly computes a fixed</span>
    <span class="c1"># effect across the two sessions</span>
    <span class="n">z_map</span> <span class="o">=</span> <span class="n">glm</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span>
        <span class="n">contrast_val</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;z_score&#39;</span><span class="p">)</span>

    <span class="c1"># write the resulting stat images to file</span>
    <span class="n">z_image_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">write_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_z_map.nii.gz&#39;</span> <span class="o">%</span> <span class="n">contrast_id</span><span class="p">)</span>
    <span class="n">z_map</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_image_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="quality-check">
<h2><strong>4.0 Quality check</strong><a class="headerlink" href="#quality-check" title="Permalink to this heading">#</a></h2>
<section id="model-evaluation">
<h3><strong>4.1 Model evaluation</strong><a class="headerlink" href="#model-evaluation" title="Permalink to this heading">#</a></h3>
<p>Since we now calculated all contrasts, it is time to check the quality of the glm we produced and applied. Lets start with the model evaluation. We evalute the model by inspecting R-Squared.</p>
<div class="alert alert-block alert-success">
At first a anatomical reference image is plotted. To check if everything was modelled correct, we are expecting only voxels within grey matter areas to respond to the general linear model, leading to an increased R-square value.</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">path_ref_img</span> <span class="o">=</span> <span class="s1">&#39;/home/jpauli/ds001506/sub-01/ses-anatomy/anat&#39;</span>
<span class="n">coordinates_anat</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ref_anat_T1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_ref_img</span> <span class="p">,</span><span class="s1">&#39;sub-01_ses-anatomy_T1w.nii.gz&#39;</span><span class="p">)</span>
<span class="n">plot_anat</span><span class="p">(</span><span class="n">ref_anat_T1</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span> <span class="o">=</span> <span class="n">coordinates_anat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f02956af828&gt;
</pre></div>
</div>
<img alt="../_images/cb16f145d688bb2100354983f5beae50739d0b4d2f0bee21b4b9553083b31368.png" src="../_images/cb16f145d688bb2100354983f5beae50739d0b4d2f0bee21b4b9553083b31368.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="n">coordinates_func</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">13</span><span class="p">,</span><span class="mi">35</span><span class="p">)</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">glm</span><span class="o">.</span><span class="n">r_square</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_all</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                       <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f8a910e3e10&gt;
</pre></div>
</div>
<img alt="../_images/a661910d0c806858eff62d287fac5f520f65c9b4365fcc5234126709f0c81407.png" src="../_images/a661910d0c806858eff62d287fac5f520f65c9b4365fcc5234126709f0c81407.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">glm</span><span class="o">.</span><span class="n">r_square</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_all</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                       <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f8a8765ef60&gt;
</pre></div>
</div>
<img alt="../_images/4992059eae0461eb1aef69b535b84981ae53b2795abc80d8dd923dad6946d04c.png" src="../_images/4992059eae0461eb1aef69b535b84981ae53b2795abc80d8dd923dad6946d04c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">glm</span><span class="o">.</span><span class="n">r_square</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_all</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                       <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f8a64aeb9e8&gt;
</pre></div>
</div>
<img alt="../_images/7498b89bf79cec2b04e7fdd431cf2a2d95735fdd162fc9d00efa4bb75ebad702.png" src="../_images/7498b89bf79cec2b04e7fdd431cf2a2d95735fdd162fc9d00efa4bb75ebad702.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">glm</span><span class="o">.</span><span class="n">r_square</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_all</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                       <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f8a1aa6ec88&gt;
</pre></div>
</div>
<img alt="../_images/e3a983214e3c8370e8c703bd1dde786503d2e61c0b526c67f8a8c0caf3602898.png" src="../_images/e3a983214e3c8370e8c703bd1dde786503d2e61c0b526c67f8a8c0caf3602898.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plotting</span><span class="o">.</span><span class="n">plot_stat_map</span><span class="p">(</span><span class="n">glm</span><span class="o">.</span><span class="n">r_square</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_all</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                       <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f8a16b30f98&gt;
</pre></div>
</div>
<img alt="../_images/7a831d0a986152af212687b6ded06c58ca29e2e83f1a3f90e8b2c3ac095a8dee.png" src="../_images/7a831d0a986152af212687b6ded06c58ca29e2e83f1a3f90e8b2c3ac095a8dee.png" />
</div>
</div>
<p>We can observe the pattern, that R-square is relatively low when inspecting brain areas that mostly contain white matter. We want to inspect neural activtiy, and thus are interested in grey matter areas. This means, that only the voxels within the grey matter should respond to the general linear model, meaning that higher R-square values can be observed. This can be seen in all 5 plots, meaning our glm did exactly what it needed to do.</p>
<p>Thus, we can continue with the quality check.</p>
</section>
<section id="comparing-the-results-with-literature">
<h3><strong>4.2 Comparing the results with literature</strong><a class="headerlink" href="#comparing-the-results-with-literature" title="Permalink to this heading">#</a></h3>
<p>Next step would be to check, if the results of all contrasts across runs is consistend with the literature on mental imagery. Meaning, can a similar activation pattern be seen in the z-map plots when comparing it to activation pattern, that are based on several other studies/meta analysis on mental imagery? To investigate this, I will plot the contrasts and then compare them to the activation maps on <a class="reference external" href="https://neurosynth.org/analyses/terms/mental%20imagery/">neurosynth</a>.</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/sub01-ses-01-imagery/z_maps&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
    <span class="n">plot_stat_map</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{activation}</span><span class="s1"> (fdr=0.05)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activation</span> <span class="o">=</span> <span class="n">file</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/nilearn/plotting/displays/_slicers.py:145: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`).
  facecolor=facecolor)
</pre></div>
</div>
<img alt="../_images/88a597b47ec437ccee328d2aa623540e79ee1b502286114e9e22e9cb09421bd1.png" src="../_images/88a597b47ec437ccee328d2aa623540e79ee1b502286114e9e22e9cb09421bd1.png" />
<img alt="../_images/348d803cb9761816d30f5f3d0526e47829f6f0f728c9f3f2465c27cc0a446a73.png" src="../_images/348d803cb9761816d30f5f3d0526e47829f6f0f728c9f3f2465c27cc0a446a73.png" />
<img alt="../_images/72af8b1ec6f79cfb066d6642443d5ba267acce00e4a58ca4f0fc1f66e7dcc4e2.png" src="../_images/72af8b1ec6f79cfb066d6642443d5ba267acce00e4a58ca4f0fc1f66e7dcc4e2.png" />
<img alt="../_images/d5343b9589500e6e1faec5b70c1faa3a8c4c2ed5f67f871edca168f9bf4a8bb7.png" src="../_images/d5343b9589500e6e1faec5b70c1faa3a8c4c2ed5f67f871edca168f9bf4a8bb7.png" />
<img alt="../_images/5d1e73b3a4554269ca56bf0beb1183e1779e3918763041c5c9f5725d5a18673a.png" src="../_images/5d1e73b3a4554269ca56bf0beb1183e1779e3918763041c5c9f5725d5a18673a.png" />
<img alt="../_images/1c65e6f5d8f62d333c6b16bcc07a6efc60424d2e5722282d7c3594e6e9c4ee8a.png" src="../_images/1c65e6f5d8f62d333c6b16bcc07a6efc60424d2e5722282d7c3594e6e9c4ee8a.png" />
<img alt="../_images/89438c8442c1df1620b90d859cbda47261a77ab285a6692a9bdf177a931711dc.png" src="../_images/89438c8442c1df1620b90d859cbda47261a77ab285a6692a9bdf177a931711dc.png" />
<img alt="../_images/80fabe4247b95cdc4445aa6ff5d6c69a83f4fb0a85bccaee152f8c87aff0e350.png" src="../_images/80fabe4247b95cdc4445aa6ff5d6c69a83f4fb0a85bccaee152f8c87aff0e350.png" />
<img alt="../_images/dcc61d9bba9c1e62a3dd56ad56b76116942dd71d162b5098897008ecf2079363.png" src="../_images/dcc61d9bba9c1e62a3dd56ad56b76116942dd71d162b5098897008ecf2079363.png" />
<img alt="../_images/365f45289303974efcd3a60850635cc5c6b3e36db483377d7ded317531bdad6a.png" src="../_images/365f45289303974efcd3a60850635cc5c6b3e36db483377d7ded317531bdad6a.png" />
<img alt="../_images/b5497477b4a306db9565bd4d15b58dadbf877b163471ab3fcc931cda94b5dc57.png" src="../_images/b5497477b4a306db9565bd4d15b58dadbf877b163471ab3fcc931cda94b5dc57.png" />
<img alt="../_images/1ecf2c8fbe48731e2a9838e896d9aeadff03fbf35e07c0819708f63622f5ec87.png" src="../_images/1ecf2c8fbe48731e2a9838e896d9aeadff03fbf35e07c0819708f63622f5ec87.png" />
<img alt="../_images/36b4a159c40d1441599401780dd2dcc61f3a27cc699b1f83400752ffc7460797.png" src="../_images/36b4a159c40d1441599401780dd2dcc61f3a27cc699b1f83400752ffc7460797.png" />
<img alt="../_images/c1ff53a6ff1455611b2a124b04b3ac9fb692c22f1a7c88eff22ce1d9188f0c1b.png" src="../_images/c1ff53a6ff1455611b2a124b04b3ac9fb692c22f1a7c88eff22ce1d9188f0c1b.png" />
<img alt="../_images/d3c520c86f0e40373039ea466d0aed1901df356bfff11c2dbb10634b7cc1f026.png" src="../_images/d3c520c86f0e40373039ea466d0aed1901df356bfff11c2dbb10634b7cc1f026.png" />
<img alt="../_images/fa0add7608246dc598a2e7fbe5a1487ae46c4da519b755fd890a6f3452b5f470.png" src="../_images/fa0add7608246dc598a2e7fbe5a1487ae46c4da519b755fd890a6f3452b5f470.png" />
<img alt="../_images/ee73d527b1f6b357124fb26b361a4d686bbc257226517bbc19f21293f6fe5c58.png" src="../_images/ee73d527b1f6b357124fb26b361a4d686bbc257226517bbc19f21293f6fe5c58.png" />
<img alt="../_images/ced075aee646bd2b63d56aa98da08d5c889b6f896234c78e08b1c32bb7dd5e1a.png" src="../_images/ced075aee646bd2b63d56aa98da08d5c889b6f896234c78e08b1c32bb7dd5e1a.png" />
<img alt="../_images/cde76736fcfb81a91066b082a0590614ec7fc09768720ed360016ff5919582fa.png" src="../_images/cde76736fcfb81a91066b082a0590614ec7fc09768720ed360016ff5919582fa.png" />
<img alt="../_images/668608752272c9d1f4e50d56e002c16f3dd14b5a2cc7d2518419371f7b438d2e.png" src="../_images/668608752272c9d1f4e50d56e002c16f3dd14b5a2cc7d2518419371f7b438d2e.png" />
<img alt="../_images/823e2e5fbb67e46f864073d79c6356682cbdcd72bfd2f2ebef8c19aaa8b6156b.png" src="../_images/823e2e5fbb67e46f864073d79c6356682cbdcd72bfd2f2ebef8c19aaa8b6156b.png" />
<img alt="../_images/ef743534841e5a3f823b1c591b293a9d28c5a05dd21a69137634dfdd0545a0ae.png" src="../_images/ef743534841e5a3f823b1c591b293a9d28c5a05dd21a69137634dfdd0545a0ae.png" />
<img alt="../_images/a987372da772b83719219dea1590b0a285876515492eb46dc73d77aa230fb0af.png" src="../_images/a987372da772b83719219dea1590b0a285876515492eb46dc73d77aa230fb0af.png" />
<img alt="../_images/226ad23325410faa5c20ef7da7f5958fb2663631d1d0eadba5913025e76aa5f7.png" src="../_images/226ad23325410faa5c20ef7da7f5958fb2663631d1d0eadba5913025e76aa5f7.png" />
<img alt="../_images/a53df649d8eed1690f0e593e48a9e6420af5a2bdf5092d02bb383355b398faec.png" src="../_images/a53df649d8eed1690f0e593e48a9e6420af5a2bdf5092d02bb383355b398faec.png" />
<img alt="../_images/a8f08f173a505786bfaef9346b0c2788a6722c4c7e626dd26d06f147fd8eaea4.png" src="../_images/a8f08f173a505786bfaef9346b0c2788a6722c4c7e626dd26d06f147fd8eaea4.png" />
</div>
</div>
<p><img alt="neuro synth" src="../_images/neurosynth.png" /></p>
<p>When looking at all 26 plots and comparing it to the one from neurosynth, we see some similarities in the activity pattern. Especially in the occipital lobe (see posterior portion of the x plot) we inspect significant activation in our plots.</p>
<p>Since the activation pattern from the plotted z-maps seem to be in accordance to the results from neurosynth we can conclude, that the results are as expected and match with prior research.</p>
</section>
<section id="plotting-design-matrices">
<h3><strong>4.3 Plotting design matrices</strong><a class="headerlink" href="#plotting-design-matrices" title="Permalink to this heading">#</a></h3>
<p>For the last step, we should make sure that the design matrices show the same pattern of stimuli onset as the event files.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">glm</span><span class="o">.</span><span class="n">design_matrices_</span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
    <span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">design_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/db3dbb06747fadd72a6d0f945a3a9e6c41b542b1944eb99378448e4d36dda1ad.png" src="../_images/db3dbb06747fadd72a6d0f945a3a9e6c41b542b1944eb99378448e4d36dda1ad.png" />
<img alt="../_images/fbf1645c8c9a4292d004cc9a7daa33c908e9ebe6b7a5a6a2e39f6d5de1fbd9c7.png" src="../_images/fbf1645c8c9a4292d004cc9a7daa33c908e9ebe6b7a5a6a2e39f6d5de1fbd9c7.png" />
<img alt="../_images/41d795e81c0263153b33c380b27f711a10651e294d0c42e73ebb31fbafe4ebf3.png" src="../_images/41d795e81c0263153b33c380b27f711a10651e294d0c42e73ebb31fbafe4ebf3.png" />
<img alt="../_images/6de54b56355c447b35e2ae5b6ae109493d7ef373f75df512383044383d9be564.png" src="../_images/6de54b56355c447b35e2ae5b6ae109493d7ef373f75df512383044383d9be564.png" />
<img alt="../_images/10f728c7fc55489b2427aa3cdfdf7139235c85bba6e4dfc244cfe3d7bdefa52c.png" src="../_images/10f728c7fc55489b2427aa3cdfdf7139235c85bba6e4dfc244cfe3d7bdefa52c.png" />
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="k">for</span> <span class="n">run</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">events_all_runs</span><span class="p">[</span><span class="n">run</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#sort values, because values are also sorted in design matrix.</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">events_all_runs</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;category_id&#39;</span><span class="p">]</span>
    <span class="n">categories_no_nan</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">cat_string</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">106</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">categories_no_nan</span><span class="p">):</span>
        <span class="n">cat_string</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">events_all_runs</span><span class="p">[</span><span class="n">run</span><span class="p">][</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_string</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">g</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">events_all_runs</span><span class="p">[</span><span class="n">run</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;stimulus&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;onset&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>
    <span class="n">g</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Imagery session sub01-ses01-run</span><span class="si">{number}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span> <span class="o">=</span> <span class="n">run</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/044e3b11ef0f8c333722b7bcd9e51f919849aa61cc632547e3cb5f4a445ada64.png" src="../_images/044e3b11ef0f8c333722b7bcd9e51f919849aa61cc632547e3cb5f4a445ada64.png" />
<img alt="../_images/f16fef22a4d92d087868af86940e8095902a63c48f9fde00eb5d7fa323eae62b.png" src="../_images/f16fef22a4d92d087868af86940e8095902a63c48f9fde00eb5d7fa323eae62b.png" />
<img alt="../_images/359269508f74d91b21f42074e7b3a2efb6148c8df7d6ce65f2014dc674bb22de.png" src="../_images/359269508f74d91b21f42074e7b3a2efb6148c8df7d6ce65f2014dc674bb22de.png" />
<img alt="../_images/2b17fbe2ad2e23638f87c5d9597e39ac78619b039e740e5cfd0b8f34db8ef68d.png" src="../_images/2b17fbe2ad2e23638f87c5d9597e39ac78619b039e740e5cfd0b8f34db8ef68d.png" />
<img alt="../_images/262e5c469890dd899ef3e01ea98209734f05ff4be0239b491ed9ab41aae0caf2.png" src="../_images/262e5c469890dd899ef3e01ea98209734f05ff4be0239b491ed9ab41aae0caf2.png" />
</div>
</div>
<p>Since the pattern is equal for the respective runs of the design matrices and event files, we can now proceed with the other sessions.</p>
</section>
</section>
<section id="calculating-z-maps-perrun-for-all-sessions">
<h2><strong>5.0 Calculating z-maps perrun for all  sessions</strong><a class="headerlink" href="#calculating-z-maps-perrun-for-all-sessions" title="Permalink to this heading">#</a></h2>
<p>Since we have the data for three more sessions, we will apply the contrast computation for per run for each session. This way we can use split the existing z-maps into training and testing data, i.e. cross validating our model.</p>
<p>We will simply repeat all the step from section 3.0. Thus, I wont provide a detailed explanation on what is happening in the individual steps. The code is simply adapted a bit to iterate to all session folders and apply the same steps of section 3.0 to each folder.</p>
<p>Please note, that the functional files have been reprocessed. They are now in the respective subject anatomical space.</p>
<p>Further important notice:
We will calculate the glm PER RUN and not across runs. This way we end up with more z_maps aka more data for the machine learning algorithm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/mnt/c/Users/janos/git/Sessions_new&quot;</span><span class="p">)</span>
<span class="n">func_images</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span><span class="s2">&quot;02&quot;</span><span class="p">,</span><span class="s2">&quot;03&quot;</span><span class="p">,</span><span class="s2">&quot;04&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span><span class="s2">&quot;02&quot;</span><span class="p">,</span><span class="s2">&quot;03&quot;</span><span class="p">,</span><span class="s2">&quot;04&quot;</span><span class="p">,</span><span class="s2">&quot;05&quot;</span><span class="p">]:</span> 
            <span class="n">func_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sub-01_ses-imagery</span><span class="si">{}</span><span class="s1">_task-imagery_run-</span><span class="si">{}</span><span class="s1">_desc-preproc_bold.nii.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
      
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">func_images</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery02_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery02_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery02_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery02_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery02_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery03_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery03_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery03_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery03_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery03_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery04_task-imagery_run-01_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery04_task-imagery_run-02_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery04_task-imagery_run-03_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery04_task-imagery_run-04_desc-preproc_bold.nii.gz&#39;,
 &#39;sub-01_ses-imagery04_task-imagery_run-05_desc-preproc_bold.nii.gz&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_1_perrun&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_2_perrun&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_3_perrun&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_4_perrun&#39;</span><span class="p">)</span>

<span class="n">ses_1</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_1_perrun&#39;</span>
<span class="n">ses_2</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_2_perrun&#39;</span>
<span class="n">ses_3</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_3_perrun&#39;</span>
<span class="n">ses_4</span> <span class="o">=</span> <span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_4_perrun&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">glm</span> <span class="o">=</span> <span class="n">FirstLevelModel</span><span class="p">(</span><span class="n">t_r</span> <span class="o">=</span> <span class="n">T_R</span><span class="p">,</span> <span class="n">hrf_model</span> <span class="o">=</span> <span class="s1">&#39;spm&#39;</span><span class="p">,</span>
                           <span class="n">slice_time_ref</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> 
                           <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">,</span>
                           <span class="n">high_pass</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> 
                           <span class="n">noise_model</span><span class="o">=</span><span class="s1">&#39;ar1&#39;</span><span class="p">,</span>
                           <span class="n">minimize_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">hrf_model</span> <span class="o">=</span> <span class="s1">&#39;glover&#39;</span>
<span class="n">run_num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#j = 8</span>

<span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span><span class="s2">&quot;02&quot;</span><span class="p">,</span><span class="s2">&quot;03&quot;</span><span class="p">,</span><span class="s2">&quot;04&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span><span class="s2">&quot;02&quot;</span><span class="p">,</span><span class="s2">&quot;03&quot;</span><span class="p">,</span><span class="s2">&quot;04&quot;</span><span class="p">,</span><span class="s2">&quot;05&quot;</span><span class="p">]:</span>
            <span class="n">confounds__</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/sessions_new/sub01-ses-</span><span class="si">{}</span><span class="s1">-imagery/sub-01_ses-imagery</span><span class="si">{}</span><span class="s1">_task-imagery_run-</span><span class="si">{}</span><span class="s1">_desc-preproc_confounds.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">session</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
            <span class="n">reg_no_interest__</span> <span class="o">=</span> <span class="n">confounds__</span><span class="p">[[</span><span class="s1">&#39;global_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_x&#39;</span><span class="p">,</span><span class="s1">&#39;trans_z&#39;</span><span class="p">,</span><span class="s1">&#39;trans_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_x&#39;</span><span class="p">,</span><span class="s1">&#39;rot_y&#39;</span><span class="p">,</span><span class="s1">&#39;rot_z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">events_all_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s1">&#39;/home/jpauli/ds001506/sub-01/ses-imagery</span><span class="si">{}</span><span class="s1">/func/sub-01_ses-imagery</span><span class="si">{}</span><span class="s1">_task-imagery_run-</span><span class="si">{}</span><span class="s1">_events.tsv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">,</span><span class="n">session</span><span class="p">,</span><span class="n">run</span><span class="p">))</span>
            <span class="n">stimuli_all_</span> <span class="o">=</span> <span class="n">trialtype</span><span class="p">(</span><span class="n">events_all_</span><span class="p">)</span>
            <span class="n">regressors_of_interest_all_</span> <span class="o">=</span> <span class="n">events_all_</span><span class="p">[[</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">]]</span>
            <span class="n">regressors_of_interest_all_</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stimuli_all_</span>
            <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_first_level_design_matrix</span><span class="p">(</span>
            <span class="n">frame_times</span><span class="p">,</span> <span class="n">regressors_of_interest_all_</span><span class="p">,</span> <span class="n">drift_model</span><span class="o">=</span><span class="s1">&#39;polynomial&#39;</span><span class="p">,</span> <span class="n">drift_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">add_regs</span><span class="o">=</span><span class="n">reg_no_interest__</span><span class="p">,</span> <span class="n">add_reg_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hrf_model</span><span class="o">=</span><span class="n">hrf_model</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/mnt/c/Users/janos/git/sessions_new/sub01-ses-</span><span class="si">{}</span><span class="s2">-imagery&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
            <span class="n">glm_ses</span> <span class="o">=</span> <span class="n">glm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">func_images</span><span class="p">[</span><span class="n">run_num</span><span class="p">],</span><span class="n">design_matrices</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">run_num</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func_images</span><span class="p">[</span><span class="n">run_num</span><span class="p">])</span>
            <span class="n">run_num</span><span class="o">=</span><span class="n">run_num</span><span class="o">+</span><span class="mi">1</span>
            
                <span class="c1">#j=0</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">z_maps_new</span><span class="o">=</span><span class="n">glm_ses</span><span class="o">.</span><span class="n">compute_contrast</span><span class="p">(</span>
                <span class="n">contrast_val</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s1">&#39;z_score&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session</span> <span class="o">==</span> <span class="s2">&quot;01&quot;</span><span class="p">:</span>
                    <span class="n">z_image_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ses_1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_z_map.nii.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">contrast_id</span><span class="p">,</span><span class="n">run_num</span><span class="p">))</span>
                    <span class="n">z_maps_new</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_image_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session</span> <span class="o">==</span> <span class="s2">&quot;02&quot;</span><span class="p">:</span>
                    <span class="n">z_image_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ses_2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_z_map.nii.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">contrast_id</span><span class="p">,</span><span class="n">run_num</span><span class="p">))</span>
                    <span class="n">z_maps_new</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_image_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session</span> <span class="o">==</span> <span class="s2">&quot;03&quot;</span><span class="p">:</span>
                    <span class="n">z_image_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ses_3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_z_map.nii.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">contrast_id</span><span class="p">,</span><span class="n">run_num</span><span class="p">))</span>      
                    <span class="n">z_maps_new</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_image_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">session</span> <span class="o">==</span> <span class="s2">&quot;04&quot;</span><span class="p">:</span>
                    <span class="n">z_image_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ses_4</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_z_map.nii.gz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">contrast_id</span><span class="p">,</span><span class="n">run_num</span><span class="p">))</span>
                    <span class="n">z_maps_new</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">z_image_path</span><span class="p">)</span>
          

        
        



 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery01_task-imagery_run-01_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery01_task-imagery_run-02_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery01_task-imagery_run-03_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery01_task-imagery_run-04_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery01_task-imagery_run-05_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery02_task-imagery_run-01_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery02_task-imagery_run-02_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery02_task-imagery_run-03_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery02_task-imagery_run-04_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery02_task-imagery_run-05_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery03_task-imagery_run-01_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery03_task-imagery_run-02_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery03_task-imagery_run-03_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery03_task-imagery_run-04_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery03_task-imagery_run-05_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery04_task-imagery_run-01_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery04_task-imagery_run-02_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery04_task-imagery_run-03_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery04_task-imagery_run-04_desc-preproc_bold.nii.gz
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/jpauli/miniconda3/envs/neuro_ai/lib/python3.7/site-packages/ipykernel_launcher.py:13: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  del sys.path[0]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-01_ses-imagery04_task-imagery_run-05_desc-preproc_bold.nii.gz
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
Great! We now calculated a z-map for each stimuli per run! It makes sense to check if the voxel pattern are still comparable.</div><p>We reprocessed the functional data, meaning that they are no longer in ‘functional subject space’, but rather in the anatomical subject space. This is imporant for comparability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">mean_img</span>
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_img</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/mnt/c/Users/janos/git/Sessions_new/sub01-ses-01-imagery&quot;</span><span class="p">)</span>
<span class="n">mean_img_new</span> <span class="o">=</span> <span class="n">mean_img</span><span class="p">(</span><span class="n">func_images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plot_img</span><span class="p">(</span><span class="n">mean_img_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;nilearn.plotting.displays._slicers.OrthoSlicer at 0x7f3c4af67940&gt;
</pre></div>
</div>
<img alt="../_images/6685ea4bc9565de9c87a387677b7a5caae6bf32ee59ae258681f29eef570e198.png" src="../_images/6685ea4bc9565de9c87a387677b7a5caae6bf32ee59ae258681f29eef570e198.png" />
</div>
</div>
<div class="alert alert-block alert-success">
Please note: The loops below work with an index variable 'c'. This is due to the fact, that the z_map folders perrun contain a lot of z_maps and plotting every single map would blow up the computational ability of my device. Thus, only the first 15 aka the z maps for the first 3 stimuli are plotted.</div><div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">=</span><span class="mi">0</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_1_perrun&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">z_map</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
    <span class="n">plot_stat_map</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_new</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{activation}</span><span class="s1"> (fdr=0.05)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activation</span> <span class="o">=</span> <span class="n">z_map</span><span class="p">))</span>
    <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/325f759bed9550ffdcc2c1809e54798caa77af4e2594ce0567fc65efc5135ca2.png" src="../_images/325f759bed9550ffdcc2c1809e54798caa77af4e2594ce0567fc65efc5135ca2.png" />
<img alt="../_images/5c1a32160b559d3a1e117285f9fa62c1e5016483b4c765fbbe3b9087339526d2.png" src="../_images/5c1a32160b559d3a1e117285f9fa62c1e5016483b4c765fbbe3b9087339526d2.png" />
<img alt="../_images/6b9192c03da85ef77b183760960e2dcc7760461c25249fdfa2a0bbd5bc6f2107.png" src="../_images/6b9192c03da85ef77b183760960e2dcc7760461c25249fdfa2a0bbd5bc6f2107.png" />
<img alt="../_images/90b0e6a12f2e2c492cf5bdd2307c826ccfce10884a78504e70a38bb86ad2cfeb.png" src="../_images/90b0e6a12f2e2c492cf5bdd2307c826ccfce10884a78504e70a38bb86ad2cfeb.png" />
<img alt="../_images/f542c83f54ca010040440816c2a3fc94448111fec46eeaf65641ae92d96287bf.png" src="../_images/f542c83f54ca010040440816c2a3fc94448111fec46eeaf65641ae92d96287bf.png" />
<img alt="../_images/5bd97dd3ffb04c4ff3941880f9ec7d3146ea2808bc5d7b36591852cdf94dd33a.png" src="../_images/5bd97dd3ffb04c4ff3941880f9ec7d3146ea2808bc5d7b36591852cdf94dd33a.png" />
<img alt="../_images/87429ac8246cab7f9bdba70ef3b6105bc45b441228222ee69801ecbe802e1fe2.png" src="../_images/87429ac8246cab7f9bdba70ef3b6105bc45b441228222ee69801ecbe802e1fe2.png" />
<img alt="../_images/d23c80c90530d68d519eae8d57dc60f6b777376e115aaddefcbd4277aab5edbd.png" src="../_images/d23c80c90530d68d519eae8d57dc60f6b777376e115aaddefcbd4277aab5edbd.png" />
<img alt="../_images/651af8d2a88f57d26720a16834399ec82d906e4e607a2b9cd993cdc002683bb9.png" src="../_images/651af8d2a88f57d26720a16834399ec82d906e4e607a2b9cd993cdc002683bb9.png" />
<img alt="../_images/fdf14e44bea58f2c6fb82d57b0bda8f9dcf65f20aee9b40aa64e5387787e54a2.png" src="../_images/fdf14e44bea58f2c6fb82d57b0bda8f9dcf65f20aee9b40aa64e5387787e54a2.png" />
<img alt="../_images/01c5fd3563e8493f5c8c30c6b955dd204af4fcab5975a4c3ba539a6cc5a3b13a.png" src="../_images/01c5fd3563e8493f5c8c30c6b955dd204af4fcab5975a4c3ba539a6cc5a3b13a.png" />
<img alt="../_images/1652c73903ebb83d98eccc17988807bb04f63348bcfd3ae87357bd20f0acab34.png" src="../_images/1652c73903ebb83d98eccc17988807bb04f63348bcfd3ae87357bd20f0acab34.png" />
<img alt="../_images/1987aeaf1531a2e2c77dbcb7a1672c36e7c6c77abacbcf233ef00df2d254c862.png" src="../_images/1987aeaf1531a2e2c77dbcb7a1672c36e7c6c77abacbcf233ef00df2d254c862.png" />
<img alt="../_images/bacba39e71d0ad2ddd14ae66f09495af84dd285f061c1c152c5590f18e380e49.png" src="../_images/bacba39e71d0ad2ddd14ae66f09495af84dd285f061c1c152c5590f18e380e49.png" />
<img alt="../_images/53a85d65d20a6bb171e32ea2cb37d8427d26babf7ba736e3fc333d78854823d8.png" src="../_images/53a85d65d20a6bb171e32ea2cb37d8427d26babf7ba736e3fc333d78854823d8.png" />
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_2_perrun&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">z_map</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
    <span class="n">plot_stat_map</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_new</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{activation}</span><span class="s1"> (fdr=0.05)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activation</span> <span class="o">=</span> <span class="n">z_map</span><span class="p">))</span>
    <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3089765c7d400bf643971648524c51148a3f384333dbb524b75819565f434cd1.png" src="../_images/3089765c7d400bf643971648524c51148a3f384333dbb524b75819565f434cd1.png" />
<img alt="../_images/b58882e39db3cb3afe20d6745a5b07b46c25af51154d74eaa8f3799c90a3d058.png" src="../_images/b58882e39db3cb3afe20d6745a5b07b46c25af51154d74eaa8f3799c90a3d058.png" />
<img alt="../_images/b97c564f9f90046b0f5396ef2a3572294a661ad198ec8b97eab67abbe25f6692.png" src="../_images/b97c564f9f90046b0f5396ef2a3572294a661ad198ec8b97eab67abbe25f6692.png" />
<img alt="../_images/fdc5a279363387078dd9fd044588732e93ff7fa6ec424c3cabd1cd514d615eb3.png" src="../_images/fdc5a279363387078dd9fd044588732e93ff7fa6ec424c3cabd1cd514d615eb3.png" />
<img alt="../_images/833f0404ea6f1da9697eba5b7ad95aaa38c71d4179fedf6b2940135d645787f4.png" src="../_images/833f0404ea6f1da9697eba5b7ad95aaa38c71d4179fedf6b2940135d645787f4.png" />
<img alt="../_images/3735bafda5dd6d1a3c0178e362cc56e641c9b2546bd5aec11eeda1fc5db3aa63.png" src="../_images/3735bafda5dd6d1a3c0178e362cc56e641c9b2546bd5aec11eeda1fc5db3aa63.png" />
<img alt="../_images/8e7566efdabf4552b1a6a1843f6890bd4d5ca09da4231308e013f8eae8b28c89.png" src="../_images/8e7566efdabf4552b1a6a1843f6890bd4d5ca09da4231308e013f8eae8b28c89.png" />
<img alt="../_images/5047bc3c1677d5bdf00c176ca328bebb21a4f321ba4851f9fe61b8594d513646.png" src="../_images/5047bc3c1677d5bdf00c176ca328bebb21a4f321ba4851f9fe61b8594d513646.png" />
<img alt="../_images/312d7d0ddd4d0b9514724f871dccd1cfcefe926fcd3c3703eb7a7f9a55042097.png" src="../_images/312d7d0ddd4d0b9514724f871dccd1cfcefe926fcd3c3703eb7a7f9a55042097.png" />
<img alt="../_images/1859d824f6dea783c5cc8837ec1585b15a588ff9cb814feb46eef185ab5e3346.png" src="../_images/1859d824f6dea783c5cc8837ec1585b15a588ff9cb814feb46eef185ab5e3346.png" />
<img alt="../_images/a965a12a9feced935e1d93c405010ddb757b2d882c172ef6301bc1e8a41227ce.png" src="../_images/a965a12a9feced935e1d93c405010ddb757b2d882c172ef6301bc1e8a41227ce.png" />
<img alt="../_images/a1f669fad1cfe3536c624b2cb112ec293528df1280e8f75b8835df1564c19eae.png" src="../_images/a1f669fad1cfe3536c624b2cb112ec293528df1280e8f75b8835df1564c19eae.png" />
<img alt="../_images/b300a664ffc08990eed20dabda4343a123177e0c61babac10dd2a5efd41b63c8.png" src="../_images/b300a664ffc08990eed20dabda4343a123177e0c61babac10dd2a5efd41b63c8.png" />
<img alt="../_images/6954abf1a81a47d48f02fd468f72fa4014d5d0c16a0f5e155b7eb66845653625.png" src="../_images/6954abf1a81a47d48f02fd468f72fa4014d5d0c16a0f5e155b7eb66845653625.png" />
<img alt="../_images/f32847c81fc2c464bacc1a61c8c1adc3d8ed942ab34d81db14fce491683c54d6.png" src="../_images/f32847c81fc2c464bacc1a61c8c1adc3d8ed942ab34d81db14fce491683c54d6.png" />
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_3_perrun&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">z_map</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
    <span class="n">plot_stat_map</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_new</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{activation}</span><span class="s1"> (fdr=0.05)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activation</span> <span class="o">=</span> <span class="n">z_map</span><span class="p">))</span>
    <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5dd01ea1d6685ae43f636573cc30713baceab9ff60e4ce982d1d5198e6810a95.png" src="../_images/5dd01ea1d6685ae43f636573cc30713baceab9ff60e4ce982d1d5198e6810a95.png" />
<img alt="../_images/75d847ebbafc0a3cc3ddeee1718b2e68785e9a33f1b70f8f6cef8b6860f7becb.png" src="../_images/75d847ebbafc0a3cc3ddeee1718b2e68785e9a33f1b70f8f6cef8b6860f7becb.png" />
<img alt="../_images/26524537504bf15675f3118c7aa745706242b02941f6896dcc48c12dabd88576.png" src="../_images/26524537504bf15675f3118c7aa745706242b02941f6896dcc48c12dabd88576.png" />
<img alt="../_images/b77f3d61f4601871cbac03701f13c4efb74b3c1f961505768b2fbd6c779eaab3.png" src="../_images/b77f3d61f4601871cbac03701f13c4efb74b3c1f961505768b2fbd6c779eaab3.png" />
<img alt="../_images/6870eef62a918c3692a1662f10e8af48ab136c3a6ac723ccffd4a6ed8800da7c.png" src="../_images/6870eef62a918c3692a1662f10e8af48ab136c3a6ac723ccffd4a6ed8800da7c.png" />
<img alt="../_images/e6bb3c4472751a0ceabf6d597d0791ebc23217c84aabd2315facb574b02b387a.png" src="../_images/e6bb3c4472751a0ceabf6d597d0791ebc23217c84aabd2315facb574b02b387a.png" />
<img alt="../_images/e4f5eea620efe8a5efed2e92d1e9eb33bbd1f215f985b195f80a74f4e5bb1f8d.png" src="../_images/e4f5eea620efe8a5efed2e92d1e9eb33bbd1f215f985b195f80a74f4e5bb1f8d.png" />
<img alt="../_images/cd653bced490b167ea7a5b95d87f6a945106b33a7314c71c9ae02c11daf18448.png" src="../_images/cd653bced490b167ea7a5b95d87f6a945106b33a7314c71c9ae02c11daf18448.png" />
<img alt="../_images/2efb789396744c97d85b9aa2912d9c1ccf18235242f3a850c3a16299d9e63123.png" src="../_images/2efb789396744c97d85b9aa2912d9c1ccf18235242f3a850c3a16299d9e63123.png" />
<img alt="../_images/fb0fb6df072429ba9e8a49fc66936c92932f6f67ddece6cc2c3af62f57ee64c4.png" src="../_images/fb0fb6df072429ba9e8a49fc66936c92932f6f67ddece6cc2c3af62f57ee64c4.png" />
<img alt="../_images/afdf21e49b43d0358887211ef1a2785b3e6aecddef5f1ca7b599c935e97a8025.png" src="../_images/afdf21e49b43d0358887211ef1a2785b3e6aecddef5f1ca7b599c935e97a8025.png" />
<img alt="../_images/3ab89489ee2772fcdf7b98bc2bf563e7779a64f2dfcffdf87e77c2407ecfe5a3.png" src="../_images/3ab89489ee2772fcdf7b98bc2bf563e7779a64f2dfcffdf87e77c2407ecfe5a3.png" />
<img alt="../_images/ac709cb11611747c077e30e9654fe2ffd57f3100c80c730385e974f296b082bf.png" src="../_images/ac709cb11611747c077e30e9654fe2ffd57f3100c80c730385e974f296b082bf.png" />
<img alt="../_images/4d560fd6a81b42fef4b90ee6733a67943249c4cc422c490f70127393cd2915e0.png" src="../_images/4d560fd6a81b42fef4b90ee6733a67943249c4cc422c490f70127393cd2915e0.png" />
<img alt="../_images/c9194e5b1bf825bac0d08948f7806a8df0dc75c4bedbc0cd89919db6eb743c98.png" src="../_images/c9194e5b1bf825bac0d08948f7806a8df0dc75c4bedbc0cd89919db6eb743c98.png" />
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;/mnt/c/Users/janos/git/Sessions_new/z_maps_4_perrun&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">z_map</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold_stats_img</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">height_control</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">)</span>
    <span class="n">plot_stat_map</span><span class="p">(</span><span class="n">z_map</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">mean_img_new</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="n">coordinates_func</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{activation}</span><span class="s1"> (fdr=0.05)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">activation</span> <span class="o">=</span> <span class="n">z_map</span><span class="p">))</span>
    <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">==</span><span class="mi">15</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e0405871fe34ae8f83c0ca77b857c916bc0bd8ab81f48b8268698e7b69478eae.png" src="../_images/e0405871fe34ae8f83c0ca77b857c916bc0bd8ab81f48b8268698e7b69478eae.png" />
<img alt="../_images/9f442f8de78ce673b1dd03c6fa17fe2b45cf8ab95533bf706d92663eb175e441.png" src="../_images/9f442f8de78ce673b1dd03c6fa17fe2b45cf8ab95533bf706d92663eb175e441.png" />
<img alt="../_images/2cf985a1ba3b718de28b8ed21e2d578bf7e79e1c2afc578d20c14d0bfe1ed3bb.png" src="../_images/2cf985a1ba3b718de28b8ed21e2d578bf7e79e1c2afc578d20c14d0bfe1ed3bb.png" />
<img alt="../_images/667df7820ee074a491b3aa88fe5cc60e7f266b911e18bf2501f1ff531d4cb1c5.png" src="../_images/667df7820ee074a491b3aa88fe5cc60e7f266b911e18bf2501f1ff531d4cb1c5.png" />
<img alt="../_images/d604fd524a1314484e39374f41ffd5abee2e9eff7f83d9ff925d4ad9340e25d8.png" src="../_images/d604fd524a1314484e39374f41ffd5abee2e9eff7f83d9ff925d4ad9340e25d8.png" />
<img alt="../_images/47db9d819b1e66456e63fa4424034619b95c6c189b6179415f46808c2c85c10b.png" src="../_images/47db9d819b1e66456e63fa4424034619b95c6c189b6179415f46808c2c85c10b.png" />
<img alt="../_images/6c1d4d96895778213100f186928c208115810f98970a30acc1962c59e6cc77f6.png" src="../_images/6c1d4d96895778213100f186928c208115810f98970a30acc1962c59e6cc77f6.png" />
<img alt="../_images/1db16b4a423e33ad54ede5a44be8376d2517328c931735f7b833560fee3cfe51.png" src="../_images/1db16b4a423e33ad54ede5a44be8376d2517328c931735f7b833560fee3cfe51.png" />
<img alt="../_images/047194bbc315327648b99649fe68c5424dc7d1e1fdc6cdbf26df10e45b6cc8ca.png" src="../_images/047194bbc315327648b99649fe68c5424dc7d1e1fdc6cdbf26df10e45b6cc8ca.png" />
<img alt="../_images/613675abeab0f1135b66e053df9360c7edd406addcedac2c1f4c1a26c29906c0.png" src="../_images/613675abeab0f1135b66e053df9360c7edd406addcedac2c1f4c1a26c29906c0.png" />
<img alt="../_images/e21d25fcb646f15609cb45ffe0aa356cd1a3c32fa06c1cb6b15dbe820efcd40d.png" src="../_images/e21d25fcb646f15609cb45ffe0aa356cd1a3c32fa06c1cb6b15dbe820efcd40d.png" />
<img alt="../_images/c9e2b126185278b67ed4b7e1ca31622c58c9807eefef8d750d27644c37a5bcca.png" src="../_images/c9e2b126185278b67ed4b7e1ca31622c58c9807eefef8d750d27644c37a5bcca.png" />
<img alt="../_images/59937c34208e78064f5fe1e34a6cb3e64aa1094890a186646146d27a0a037dda.png" src="../_images/59937c34208e78064f5fe1e34a6cb3e64aa1094890a186646146d27a0a037dda.png" />
<img alt="../_images/4d89cc12a4d968e5e0f6355ce54fdee8241f7302b757e5db01cf27170f5f0e53.png" src="../_images/4d89cc12a4d968e5e0f6355ce54fdee8241f7302b757e5db01cf27170f5f0e53.png" />
<img alt="../_images/8abd8f4d97a5612021fdfd0782711c552015b735c3ae3798c1cf43198002cbfa.png" src="../_images/8abd8f4d97a5612021fdfd0782711c552015b735c3ae3798c1cf43198002cbfa.png" />
</div>
</div>
<p>The activity pattern looks somewhat comparable. We should now continue with the machine learning algorithm.</p>
<div class="alert alert-block alert-danger">
VERY IMPORANT INFORMATION:
<p>This notebook has been gone through several attempts. Please take a look at the respective github repository folder to understand the different attempts made.</p>
<p>For example: The first idea was to simply run the glm across runs and not per run. This ended up with few data points, thus the idea do run the glm perrun was executed. Also, not only the data from subject one but also from subject two has been tried out. This lead to very similar problems, which you will encounter in the following notebooks. Please accept, that it is not possible to include every attempt in this jupyter book. If you are interested in which methods I tried out, please contact me (see: Welcome page) and I’ll be very happy to discuss everything with you.  </div></p>
</section>
<section id="logistic-regression">
<h2><strong>6.0 Logistic Regression</strong><a class="headerlink" href="#logistic-regression" title="Permalink to this heading">#</a></h2>
<p>Since we now completed the GLM for all sessions, we should continue with the Logistic Regression. Please follow this jupyter book.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "neuro_ai"
        },
        kernelOptions: {
            name: "neuro_ai",
            path: "./data"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'neuro_ai'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Dataset_Exploration.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Dataset Exploration</p>
      </div>
    </a>
    <a class="right-next"
       href="../general_information/Machine_Learning.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Machine Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><strong>0. Introduction</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-model"><strong>1.0 Running the model</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#detection-of-significant-voxels"><strong>2.0 Detection of significant voxels</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-glm-for-all-runs"><strong>3.0 Performing the glm for all runs</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-check"><strong>4.0 Quality check</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-evaluation"><strong>4.1 Model evaluation</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-the-results-with-literature"><strong>4.2 Comparing the results with literature</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-design-matrices"><strong>4.3 Plotting design matrices</strong></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-z-maps-perrun-for-all-sessions"><strong>5.0 Calculating z-maps perrun for all  sessions</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression"><strong>6.0 Logistic Regression</strong></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Janos Pauli based on the course template by Felix Koerber and Michael Ernst
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>